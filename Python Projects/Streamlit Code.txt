import streamlit as st
import numpy as np
import pandas as pd
import plotly.express as px
from matplotlib import pyplot as plt

from text_cleaner import clean_text, clean_text_spacy
from NLP_functions import word_cloud, ngram_chart, detect_chunk_emotion, sentiment_analysis, classify_text, summarize

st.title('Interactive Text Analysis')
st.divider()

st.subheader('Type or Paste text here')
text = st.text_area('', height=200)

if st.button('Analyze'):
    if not text.strip():
        st.warning('Please enter text to analyze')
    else:
        # Cleaning and Processing
        cleaned_text = clean_text(text)
        tokens = clean_text_spacy(cleaned_text)

        # WORD CLOUD
        if tokens:
            st.subheader("WORD CLOUD")
            fig = word_cloud(tokens)  # Ensure it receives a single string
            st.pyplot(fig)
        st.divider()

        # N GRAM ANALYSIS
        st.subheader('N-GRAM ANALYSIS')
        ngram_chart(tokens, n=3, top_n=10)
        st.divider()

        # EMOTION DETECTION
        st.subheader('EMOTION DETECTION')
        result = detect_chunk_emotion(text)
        max_index = result['Confidence'].idxmax()
        Emotion = result.loc[max_index, 'Emotion']
        Score = result.loc[max_index, 'Confidence']
        st.write(f"Predicted Emotion: {Emotion} with {round(Score * 100)}% Confidence")
        st.dataframe(result)
        fig = px.bar(result, x='Emotion', y='Confidence', color='Emotion', title='Visualising Top 5 Emotions through Bar Chart')
        fig.update_layout(template='plotly_white', height=300)
        st.plotly_chart(fig)
        st.divider()

        # SENTIMENT ANALYSIS
        st.subheader('SENTIMENT ANALYSIS')
        result = sentiment_analysis(text)
        if 'error' not in result:
            st.write(
                f"Overall Sentiment: {result['Overall Sentiment']} with {max(result['Average Score'].values())} Score")
            df = pd.DataFrame(result['Average Score'].items(), columns=['Sentiment', 'Score'])
            st.dataframe(df)
            fig = px.bar(df, x='Sentiment', y='Score', color='Sentiment', title='Visualising Sentiments through Bar Chart')
            fig.update_layout(template='plotly_white', height=300)
            st.plotly_chart(fig)
        st.divider()

        # TONE OF SPEECH DETECTION
        st.subheader('TONE OF SPEECH DETECTION')
        result = classify_text(text)
        st.write(f"Predicted Tone: {result['Predicted_Category']} with {result['Score']} Score")
        labels = []
        scores = []
        for label, score in result["All_Categories"][0:10]:
            labels.append(label)
            scores.append(score)
        fig = px.bar(x=labels, y=scores, color=labels, title='Top 10 Tone Bar Chart')
        fig.update_layout(xaxis_title='Tone', yaxis_title='Score' , template='plotly_white', height=400)
        st.plotly_chart(fig)
        st.divider()

        # SUMMARY
        st.subheader('TEXT SUMMARY GENERATION')
        result = summarize(text)
        st.write(result)